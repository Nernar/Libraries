/*
	 _   _	  _					  _	_	  _ _	 
	| \ | |	| |					| |  | |	(_) |	
	|  \| | ___| |___	  _____  _ __| | _| |	 _| |__  
	| . ` |/ _ \ __\ \ /\ / / _ \| '__| |/ / |	| | '_ \ 
	| |\  |  __/ |_ \ V  V / (_) | |  |   <| |____| | |_) |
	|_| \_|\___|\__| \_/\_/ \___/|_|  |_|\_\______|_|_.__/ 
   														   
														   
   Copyright 2020 Nernar (github.com/nernar)
   
   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at
   
	   http://www.apache.org/licenses/LICENSE-2.0
   
   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
   
*/

LIBRARY({name:"Network",api:"AdaptedScript",shared:!1,version:1});let Network=function(t){this.callback=new Object,t&&this.setAddress(t)};Network.prototype.getUrl=function(){return this.url||null},Network.prototype.setUrl=function(t){if(t instanceof String)return Logger.Log("You should use Network.setAddress(address) instead of Network.setUrl(url) for string values","Network"),void this.setAddress(t);this.callback.hasOwnProperty("onUrlChanged")&&this.callback.onUrlChanged.call(this,t),this.url=t},Network.prototype.setAddress=function(t){return!(t instanceof Number)&&(this.setUrl(new java.net.URL(t)),!0)},Network.prototype.setCallback=function(t){t&&t instanceof Object?this.callback=t:this.callback=new Object},Network.prototype.getStream=function(){return this.url?this.url.openStream():null},Network.prototype.validateConnection=function(){null!=this.connection&&null!=this.connection||(this.connection=this.url?this.url.openConnection():null,this.callback.hasOwnProperty("onCreateConnection")&&this.callback.onCreateConnection.call(this,this.connection))},Network.prototype.getConnection=function(t){return t||this.validateConnection(),this.connection||null},Network.prototype.hasConnection=function(){return null!=this.getConnection(!0)},Network.prototype.connect=function(){let t=this.getConnection();if(!t)throw new Error("Can't find any opened connection to connect");t.connect(),this.callback.hasOwnProperty("onConnect")&&this.callback.onConnect.call(this,t)},Network.prototype.disconnect=function(){let t=this.getConnection();t&&(t.disconnect(),delete this.connection,this.callback.hasOwnProperty("onDisconnect")&&this.callback.onDisconnect.call(this,t))},Network.prototype.getLength=function(){let t=this.hasConnection();t||this.connect();let e=this.getConnection(),n=e?e.getContentLength():-1;return this.callback.hasOwnProperty("getLength")&&this.callback.getLength.call(this,n),t&&this.disconnect(),n},Network.isOnline=function(t){null!=t&&null!=t||(t=UI.getContext());let e=t.getSystemService("connectivity");if(null==e)return!1;let n=e.getActiveNetworkInfo();return!(null==n||!n.isConnectedOrConnecting())},Network.Reader=function(t){t&&this.setAddress(t)},Network.Reader.prototype=new Network,Network.Reader.prototype.charset="UTF-8",Network.Reader.prototype.getCharset=function(){return this.charset||null},Network.Reader.prototype.setCharset=function(t){t?this.charset=t:delete this.charset,this.callback.hasOwnProperty("onCharsetChanged")&&this.callback.onCharsetChanged.call(this,this.charset)},Network.Reader.prototype.getStreamReader=function(){let t=this.getStream();if(!t)return null;let e=this.getCharset();return e?new java.io.InputStreamReader(t,e):new java.io.InputStreamReader(t)},Network.Reader.prototype.inProcess=function(){return!!this.processing},Network.Reader.prototype.getCurrentlyReaded=function(){return this.result||null},Network.Reader.prototype.getReadedCount=function(){let t=this.getCurrentlyReaded();return t?t.length:-1},Network.Reader.prototype.getResult=function(){let t=this.getCurrentlyReaded();return t?t.join("\n"):null},Network.Reader.prototype.read=function(){let t=this.getStreamReader();if(!t)throw new Error("Can't read stream, because one of params is missing");let e=this.result=new Array,n=new java.io.BufferedReader(t);this.processing=!0;let r=this.getLength();for(this.callback.hasOwnProperty("onPrepare")&&this.callback.onPrepare.call(this,r);this.inProcess();){let t=n.readLine();if(null==t)break;e.push(t),this.callback.hasOwnProperty("onReadLine")&&this.callback.onReadLine.call(this,e,t)}return this.callback.hasOwnProperty("onComplete")&&this.callback.onComplete.call(this,r),delete this.processing,n.close(),this.getResult()},Network.Writer=function(t){t&&this.setAddress(t)},Network.Writer.prototype=new Network,Network.Writer.prototype.size=8192,Network.Writer.prototype.getBufferSize=function(){return this.size||-1},Network.Writer.prototype.setBufferSize=function(t){t?this.size=t:delete this.size},Network.Writer.prototype.getReadedCount=function(){return this.count?this.count:this.inProcess()?0:-1},Network.Writer.prototype.getStreamReader=function(){let t=this.getStream();if(!t)return null;let e=this.getBufferSize();return e?new java.io.BufferedInputStream(t,e):new java.io.BufferedInputStream(t)},Network.Writer.prototype.getOutputStream=function(){throw new Error("You must install a method getOutputStream()")},Network.Writer.prototype.inProcess=function(){return!!this.processing},Network.Writer.prototype.download=function(){let t=this.getStreamReader(),e=this.getOutputStream();if(!t)throw new Error("Can't download stream, because input stream is missing");if(!e)throw new Error("Can't download stream, because output stream is missing");this.connect(),this.count=0,this.processing=!0;let n=this.getLength();this.callback.hasOwnProperty("onPrepare")&&this.callback.onPrepare.call(this,n);let r=java.lang.reflect.Array.newInstance(java.lang.Byte.TYPE,1024);for(;this.inProcess();){let t=input.read(r);if(-1==t)break;e.write(r,0,t),this.callback.hasOwnProperty("onProgress")&&this.callback.onProgress.call(this,t,n),this.count+=t}this.callback.hasOwnProperty("onComplete")&&this.callback.onComplete.call(this,n),this.processing=!1,this.disconnect(),e.flush(),e.close(),t.close()},Network.Downloader=function(t,e){t&&this.setAddress(t),e&&this.setPath(e)},Network.Downloader.prototype=new Network.Writer,Network.Downloader.prototype.getFile=function(){return this.file||null},Network.Downloader.prototype.setFile=function(t){t?this.file=t:delete this.file,this.callback.hasOwnProperty("onFileChanged")&&this.callback.onFileChanged.call(this,t)},Network.Downloader.prototype.getPath=function(){let t=this.getFile();return t?t.getPath():null},Network.Downloader.prototype.setPath=function(t){let e=new java.io.File(t);e&&this.setFile(e)},Network.Downloader.prototype.getOutputStream=function(){let t=this.getFile();if(!t)return null;let e=new java.io.FileOutputStream(t);return e?new java.io.BufferedOutputStream(e):null},Network.handle=function(t,e,n){if(!(t instanceof Function))throw new Error("Nothing to handle");new java.lang.Thread(function(){try{t()}catch(t){try{if(e&&e instanceof Object){if(e.hasOwnProperty("onFail"))return void e.onFail.call(n)}else e instanceof Function&&e.call(n);Logger.Log("Failed to read data from a server","Warning")}catch(t){Logger.Log("A fatal error occurred while trying to connect","Error")}Logger.LogError(t)}}).start()},Network.lengthUrl=function(t,e){if(!Network.isOnline())return e&&e instanceof Object&&e.hasOwnProperty("isNotConnected")&&e.isNotConnected(),!1;let n=new Network.Connect(t);return e&&e instanceof Object&&e&&n.setCallback(e),this.handle(function(){e?e instanceof Object?n.getLength():e(n.getLength()):(Logger.Log("Action after doing stream length is missed","Warning"),n.getLength())},e,n),!0},Network.readUrl=function(t,e){if(!Network.isOnline())return e&&e instanceof Object&&e.hasOwnProperty("isNotConnected")&&e.isNotConnected(),!1;let n=new Network.Reader(t);return e&&e instanceof Object&&e&&n.setCallback(e),this.handle(function(){e?e instanceof Object?n.read():e(n.read()):(Logger.Log("Action after doing stream reading is missed","Warning"),n.read())},e,n),!0},Network.downloadUrl=function(t,e,n){if(!Network.isOnline())return n&&n instanceof Object&&n.hasOwnProperty("isNotConnected")&&n.isNotConnected(),!1;let r=new Network.Downloader(t,e);return n&&n instanceof Object&&n&&r.setCallback(n),this.handle(function(){n instanceof Function?n(r.download()):r.download()},n,r),!0},EXPORT("Network",Network);
